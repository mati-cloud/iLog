stages:
  - build
  - manifest
  - release

variables:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  GHCR_REGISTRY: ghcr.io
  GHCR_IMAGE: $GHCR_REGISTRY/mati-cloud/ilog
  GITHUB_REPO: mati-cloud/iLog

# Frontend builds
build:frontend:amd64:
  stage: build
  image: docker:29-cli
  services:
    - name: docker:29-dind
      command: ["dockerd-entrypoint.sh", "--host=tcp://0.0.0.0:2375", "--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    IMAGE_NAME: $GHCR_IMAGE-frontend
    PLATFORM: linux/amd64
  tags:
    - amd64
  before_script:
    - echo "$GITHUB_TOKEN" | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin
    - echo "$DOCKER_HUB_TOKEN" | docker login -u $DOCKER_HUB_USERNAME --password-stdin
  script:
    - |
      docker buildx build \
        --platform $PLATFORM \
        --file ./frontend/Dockerfile \
        --cache-from type=registry,ref=$IMAGE_NAME:buildcache-amd64 \
        --cache-to type=registry,ref=$IMAGE_NAME:buildcache-amd64,mode=max \
        --tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-amd64 \
        --tag $IMAGE_NAME:latest-amd64 \
        --push \
        --provenance=false \
        ./frontend
  only:
    - main

build:frontend:arm64:
  stage: build
  image: docker:29-cli
  services:
    - name: docker:29-dind
      command: ["dockerd-entrypoint.sh", "--host=tcp://0.0.0.0:2375", "--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    IMAGE_NAME: $GHCR_IMAGE-frontend
    PLATFORM: linux/arm64
  tags:
    - arm64
  before_script:
    - echo "$GITHUB_TOKEN" | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin
    - echo "$DOCKER_HUB_TOKEN" | docker login -u $DOCKER_HUB_USERNAME --password-stdin
  script:
    - |
      docker buildx build \
        --platform $PLATFORM \
        --file ./frontend/Dockerfile \
        --cache-from type=registry,ref=$IMAGE_NAME:buildcache-arm64 \
        --cache-to type=registry,ref=$IMAGE_NAME:buildcache-arm64,mode=max \
        --tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-arm64 \
        --tag $IMAGE_NAME:latest-arm64 \
        --push \
        --provenance=false \
        ./frontend
  only:
    - main

# Backend builds
build:backend:amd64:
  stage: build
  image: docker:29-cli
  services:
    - name: docker:29-dind
      command: ["dockerd-entrypoint.sh", "--host=tcp://0.0.0.0:2375", "--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    IMAGE_NAME: $GHCR_IMAGE-backend
    PLATFORM: linux/amd64
  tags:
    - amd64
  before_script:
    - echo "$GITHUB_TOKEN" | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin
    - echo "$DOCKER_HUB_TOKEN" | docker login -u $DOCKER_HUB_USERNAME --password-stdin
  script:
    - |
      docker buildx build \
        --platform $PLATFORM \
        --file ./backend/Dockerfile \
        --cache-from type=registry,ref=$IMAGE_NAME:buildcache-amd64 \
        --cache-to type=registry,ref=$IMAGE_NAME:buildcache-amd64,mode=max \
        --tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-amd64 \
        --tag $IMAGE_NAME:latest-amd64 \
        --push \
        --provenance=false \
        ./backend
  only:
    - main

build:backend:arm64:
  stage: build
  image: docker:29-cli
  services:
    - name: docker:29-dind
      command: ["dockerd-entrypoint.sh", "--host=tcp://0.0.0.0:2375", "--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    IMAGE_NAME: $GHCR_IMAGE-backend
    PLATFORM: linux/arm64
  tags:
    - arm64
  before_script:
    - echo "$GITHUB_TOKEN" | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin
    - echo "$DOCKER_HUB_TOKEN" | docker login -u $DOCKER_HUB_USERNAME --password-stdin
  script:
    - |
      docker buildx build \
        --platform $PLATFORM \
        --file ./backend/Dockerfile \
        --cache-from type=registry,ref=$IMAGE_NAME:buildcache-arm64 \
        --cache-to type=registry,ref=$IMAGE_NAME:buildcache-arm64,mode=max \
        --tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-arm64 \
        --tag $IMAGE_NAME:latest-arm64 \
        --push \
        --provenance=false \
        ./backend
  only:
    - main

# Create multi-arch manifests
manifest:frontend:
  stage: manifest
  image: docker:29-cli
  before_script:
    - echo "$GITHUB_TOKEN" | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin
  variables:
    IMAGE_NAME: $GHCR_IMAGE-frontend
  script:
    - |
      docker manifest create $IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-amd64 \
        $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-arm64
      docker manifest push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      docker manifest create $IMAGE_NAME:latest \
        $IMAGE_NAME:latest-amd64 \
        $IMAGE_NAME:latest-arm64
      docker manifest push $IMAGE_NAME:latest
  only:
    - main

manifest:backend:
  stage: manifest
  image: docker:29-cli
  before_script:
    - echo "$GITHUB_TOKEN" | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin
  variables:
    IMAGE_NAME: $GHCR_IMAGE-backend
  script:
    - |
      docker manifest create $IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-amd64 \
        $IMAGE_NAME:$CI_COMMIT_SHORT_SHA-arm64
      docker manifest push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      docker manifest create $IMAGE_NAME:latest \
        $IMAGE_NAME:latest-amd64 \
        $IMAGE_NAME:latest-arm64
      docker manifest push $IMAGE_NAME:latest
  only:
    - main

# ilog-agent binary builds (triggered by git tags)
build:agent:linux-amd64:
  stage: build
  image: rust:1.83-alpine
  tags:
    - amd64
  variables:
    CARGO_HOME: $CI_PROJECT_DIR/.cargo
    RUSTFLAGS: "-C target-feature=+crt-static"
  cache:
    key: agent-linux-amd64
    paths:
      - .cargo/
      - ilog-agent/target/
  before_script:
    - apk add --no-cache musl-dev
  script:
    - cd ilog-agent
    - cargo build --release --target x86_64-unknown-linux-musl --features all
    - mkdir -p ../artifacts
    - cp target/x86_64-unknown-linux-musl/release/ilog-agent ../artifacts/ilog-agent-linux-amd64
    - chmod +x ../artifacts/ilog-agent-linux-amd64
  artifacts:
    paths:
      - artifacts/ilog-agent-linux-amd64
    expire_in: 1 day
  only:
    - /^v\d+\.\d+\.\d+$/

build:agent:linux-arm64:
  stage: build
  image: rust:1.83-alpine
  tags:
    - arm64
  variables:
    CARGO_HOME: $CI_PROJECT_DIR/.cargo
    RUSTFLAGS: "-C target-feature=+crt-static"
  cache:
    key: agent-linux-arm64
    paths:
      - .cargo/
      - ilog-agent/target/
  before_script:
    - apk add --no-cache musl-dev
  script:
    - cd ilog-agent
    - cargo build --release --target aarch64-unknown-linux-musl --features all
    - mkdir -p ../artifacts
    - cp target/aarch64-unknown-linux-musl/release/ilog-agent ../artifacts/ilog-agent-linux-arm64
    - chmod +x ../artifacts/ilog-agent-linux-arm64
  artifacts:
    paths:
      - artifacts/ilog-agent-linux-arm64
    expire_in: 1 day
  only:
    - /^v\d+\.\d+\.\d+$/

# GitHub Release
release:github:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      # Extract version from tag
      VERSION=${CI_COMMIT_TAG#v}
      
      # Create release
      RELEASE_DATA=$(cat <<EOF
      {
        "tag_name": "$CI_COMMIT_TAG",
        "name": "iLog Agent $VERSION",
        "body": "Release $VERSION\n\n## Installation\n\n### Linux (amd64)\n\`\`\`bash\ncurl -L https://github.com/$GITHUB_REPO/releases/download/$CI_COMMIT_TAG/ilog-agent-linux-amd64 -o ilog-agent\nchmod +x ilog-agent\nsudo mv ilog-agent /usr/local/bin/\n\`\`\`\n\n### Linux (arm64)\n\`\`\`bash\ncurl -L https://github.com/$GITHUB_REPO/releases/download/$CI_COMMIT_TAG/ilog-agent-linux-arm64 -o ilog-agent\nchmod +x ilog-agent\nsudo mv ilog-agent /usr/local/bin/\n\`\`\`",
        "draft": false,
        "prerelease": false
      }
      EOF
      )
      
      RELEASE_RESPONSE=$(curl -X POST \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com/repos/$GITHUB_REPO/releases \
        -d "$RELEASE_DATA")
      
      RELEASE_ID=$(echo $RELEASE_RESPONSE | jq -r '.id')
      echo "Created release with ID: $RELEASE_ID"
      
      # Upload binaries
      for binary in artifacts/*; do
        if [ -f "$binary" ]; then
          FILENAME=$(basename $binary)
          echo "Uploading $FILENAME..."
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$binary" \
            "https://uploads.github.com/repos/$GITHUB_REPO/releases/$RELEASE_ID/assets?name=$FILENAME"
        fi
      done
  dependencies:
    - build:agent:linux-amd64
    - build:agent:linux-arm64
  only:
    - /^v\d+\.\d+\.\d+$/
