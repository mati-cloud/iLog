stages:
  - build

variables:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  # GitHub Container Registry
  GHCR_REGISTRY: ghcr.io
  GHCR_IMAGE: $GHCR_REGISTRY/mati-cloud/ilog

build:frontend:
  stage: build
  image: docker:29-cli
  services:
    - name: docker:29-dind
      command: ["--tls=false"]
  before_script:
    - echo "$GITHUB_TOKEN" | docker login $GHCR_REGISTRY -u $GITHUB_USERNAME --password-stdin
  variables:
    IMAGE_NAME: $GHCR_IMAGE-frontend
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  script:
    - |
      docker buildx create --use --name builder --driver docker-container || true
      docker buildx build \
        --file ./frontend/Dockerfile \
        --cache-from type=registry,ref=$IMAGE_NAME:buildcache \
        --cache-to type=registry,ref=$IMAGE_NAME:buildcache,mode=max \
        --tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        --tag $IMAGE_NAME:latest \
        --push \
        --provenance=false \
        ./frontend
  after_script:
    - docker buildx rm builder || true
  only:
    - main
